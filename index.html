<!DOCTYPE html>
<html> 
    <head> 
        <title> SANDRA - Dashboard </title>
        <meta charset="utf-8"/>
        <link rel="stylesheet" type="text/css" href="style.css">
    </head>

    <body> 
        <section id="parent">
            <section id="container"> 
                <section id="sidePanel">
                    <section id='sidePanelTitle'> <div> Sandra - Dashboard </div> </section>
                    <section id="sidePanelContent"> <!-- INFORMATION GOES HERE --> </section>
                </section>

                <section id="rightSide">
                    <section id="detailsParent" class="hide">
                        <section id='detailsTitleContainer'>
                            <h1 id='detailsName'> Log </h1>
                            <h1 id='detailsIP'> Log </h1>
                        </section>

                        <section>
                            <ul id='logger'></ul>   
                        </section>
                    </section>
                </section>
            </section>
        </section>
    </body>

    <script type="text/javascript" charset="utf-8">

        let infoDisplayActive = false;
        let infoClient = '';
        let active_clients = {}

        let websocketActive = false;
        
        const element_template = (name, data) => {
            let element = document.getElementById(client);

            let insert = 
            `<section onclick='load_info("${ name }", true)' id='${ name }' class='device'>
                <section class="dotContainer"> <section class='${ data.active ? 'active' : 'disabled' }'> </section> </section>
                <section id='name'> <section class="deviceName"> ${ name } </section> <section class="ip"> ${ data.address[0] } </section> </section>
            </section>`

            let target = document.getElementById('sidePanelContent');
            target.insertAdjacentHTML( 'beforeend', insert );
        }

        const handle_response = (json_data) => {
            active_clients = json_data;
            
            for (client in json_data) {
                let element = document.getElementById(client);

                data = json_data[client];

                if (!element) {
                    console.log("create");
                    element_template(client, data);
                }

                let target = document.querySelectorAll('#' + client + ' > .dotContainer > section');
                target[0].className = data.active ? 'active' : 'disabled';
            }
        }

        const load_logger = (logger) => {
            let target = document.getElementById('logger');
            target.innerHTML = '';
            
            for (let log in logger) {
                classType = logger[log]['logType'] == 'Error' ? 'errorLogMeesage' : '';

                let insert = `<li className="${ classType }"> ${ logger[log]['message'] } </li>`;

                target.insertAdjacentHTML( 'beforeend', insert );
            }
        }

        const load_titles = (id, address) => {
            let mainTitleTarget = document.getElementById('detailsName');
            let mainIPTarget = document.getElementById('detailsIP');

            console.log(id);
            console.log(address[0]);

            mainTitleTarget.textContent = id;
            mainIPTarget.textContent = address[0];
        }

        const load_info = (id, toggle) => {
            let detailsSection = document.getElementById("detailsParent");

            if ((infoDisplayActive && infoClient == id) && toggle) {
                infoDisplayActive = false;
                detailsSection.className = "hide";
                return;
            }

            infoClient = id;
            infoDisplayActive = true;
            detailsSection.className = "show";

            load_titles(id, active_clients[id]['address']);
            load_logger(active_clients[id]['logger']);
        }

        const connect = () => {
            console.log("Attempting to connect");
            websocket = new WebSocket("ws://localhost:8765/");
            console.log("Connected...");

            websocketActive = true;

            const interval = setInterval(() => {
                // 3 = CLOSED websocket state // https://developer.mozilla.org/en-US/docs/Web/API/WebSocket
                if (websocket.readyState === 3) {
                    console.log("CLOSING STATE, UHH OHH")
                }

                try {
                    console.log(websocket)
                    websocket.send(JSON.stringify({'ID': 'Webserver', 'type': 'get-info'}));
                } catch (error) {
                    console.log(error);
                    console.log("Error connecting")
                }
            }, 5000);

            websocket.onmessage = (event) => {
                data = JSON.parse(event.data);

                switch (data.type) {
                    case 'data_response':
                        if (infoDisplayActive) {
                            load_info(infoClient, false)
                        }

                        handle_response(data.content)
                        break;
                    
                    default:
                        console.error("unsupported event", data);
                }
            };

            // solution
            // https://stackoverflow.com/questions/22431751/websocket-how-to-automatically-reconnect-after-it-dies

            websocket.onclose = (e) => {
                console.log('Socket is closed. Reconnect will be attempted in 1 second.', e.reason);
                setTimeout(() => {
                    clearInterval(interval);
                    connect();
                }, 5000);
            };

            websocket.onerror = (error) => {
                console.log(error);
                console.log("Error connecting");
                websocket.close();
            };
        }

        let websocket = null;

        connect();
    
        // initialising

        setTimeout(() => { 
            try {
                websocket.send(JSON.stringify({'ID': 'Webserver', 'type': 'get-info'}));
            } catch (error) {
                console.log("Error connecting")
                // Attempt to reconnect to server
                //connect();
            }
        }, 250);

        
    </script>
</html>